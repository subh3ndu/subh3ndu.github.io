<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>TmpkWkwIVzAaH</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <style type="text/css">:root {--c-caption: grey;--c-blue: #26bfe3;--c-green: #02e180;--c-orange: #f2971a;--c-pink: #e3266f;--c-bg: #fff;--c-bg-alt: #f5f5f5;--c-text-header: #fff;--c-text-body: #95989a;--padding: 20px;--padding-inv: calc(-1 * var(--padding));--fonts: "Open Sans", -apple-system, system-ui, "Segoe UI", "Roboto","Helvetica Neue", Arial, sans-serif;--font-size: 1.1rem;}html {font-size: 100%;}body {color: #444;font-family: var(--fonts);font-size: var(--font-size);line-height: 1.7;padding: 1em;margin: auto;max-width: 800px;background: #fefefe;}a {color: #0645ad;text-decoration: none;}a:visited {color: #0b0080;}a:hover {color: #06e;}a:active {color: #faa700;}a:focus {outline: thin dotted;}a::selection {background: rgba(255, 255, 0, 0.3);color: #0645ad;}*::selection {background: rgba(255, 255, 0, 0.3);color: #000;}p {margin: 1em 0;}.caption {text-align: center;color: var(--c-caption);font-style: italic;}.note,.tips,.warning {display: block;width: calc(100% - var(--padding) * 2);padding: 0 var(--padding);padding-bottom: var(--padding);background-color: var(--c-bg-alt);}.note:before,.tips:before,.warning:before {display: block;margin: 0 var(--padding-inv) 10px var(--padding-inv);padding-left: var(--padding);font-style: bold;color: white;}.note:before {content: "Note";background-color: var(--c-blue);}.tips:before {content: "Tips";background-color: var(--c-pink);}.warning:before {content: "Warning";background-color: var(--c-orange);}img {max-width: 100%;}h1,h2,h3,h4,h5,h6 {color: #111;line-height: 125%;margin-top: 2em;font-weight: normal;}h4,h5,h6 {font-weight: bold;}h1 {font-size: 2.5em;}h2 {font-size: 2em;}h3 {font-size: 1.5em;}h4 {font-size: 1.2em;}blockquote {color: #666666;margin: 0;padding-left: 3em;border-left: 0.5em #eee solid;}hr {display: block;height: 2px;border: 0;border-top: 1px solid #aaa;border-bottom: 1px solid #eee;margin: 1em 0;padding: 0;}pre,code,kbd,samp {color: #0084b8;font-family: monospace, monospace;}pre {background-color: #f9f9f9;padding: 1em;font-size: 14px;white-space: pre-wrap;word-wrap: break-word;}code {white-space: pre-wrap;}b,strong {font-weight: bold;}dfn {font-style: italic;color: var(--c-blue);}ins {background: #ff9;color: #000;text-decoration: none;}ul,ol {margin: 1em 0;padding: 0 0 0 2em;}li p:last-child {margin-bottom: 0;}ul ul,ol ol {margin: 0.3em 0;}dl {margin-bottom: 1em;}dt {font-weight: bold;margin-bottom: 0.8em;}dd {margin: 0 0 0.8em 2em;}dd:last-child {margin-bottom: 0;}img {border: 0;-ms-interpolation-mode: bicubic;vertical-align: middle;}figure {display: block;text-align: center;margin: 1em 0;}figure img {border: none;margin: 0 auto;}figcaption {font-size: 0.8em;font-style: italic;margin: 0 0 0.8em;}.author {font-size: 1.2em;text-align: center;}tag {min-width: 3.2em;text-align: center;border-radius: 8px;padding: 0 4px;margin-bottom: 0;margin-top: 4px;margin-right: 0.2em;display: inline-block;color: white;}tag.update {background: var(--c-blue);}tag.new {background: var(--c-green);}tag.update:after {content: "update";}tag.new:after {content: "new";}button {background-color: var(--c-blue);color: white;border: none;cursor: pointer;line-height: 2rem;font-size: 1.2rem;margin: 0.75rem 0;overflow: visible;padding: 0.75rem 1.5rem;border-radius: 1rem;transition: background-color $transition-duration;white-space: nowrap;}</style>
</head>
<body>
<h1 id="bonus-making-our-code-reusable">Bonus: making our code reusable</h1>
<p>In this lesson we’ll focus more on organizing content and managing projects through reuse. We’ll look at these advanced topics:</p>
<ul>
<li>Classes with static functions for reusable libraries.</li>
<li>Object polymorphism through class inheritance.</li>
<li>Custom iterator classes.</li>
<li>Setters and getters.</li>
</ul>
<h2 id="refactoring-the-level-generator">Refactoring the level generator</h2>
<p>So far we crammed up everything into <code>BasicDungeon.gd</code>, but we can do better to organize our code. We’ll push the dungeon generator algorithm into a separate class with reusability in mind.</p>
<h3 id="our-first-class-library">Our first class library</h3>
<p>Let’s first do the easy stuff. Create <code>Utils.gd</code> with the following content:</p>
<pre style="color:#f8f8f2;background-color:#272822">class_name Utils


<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> lessv_x(v1: <span style="color:#a6e22e">Vector2</span>, v2: <span style="color:#a6e22e">Vector2</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#66d9ef">return</span> v1<span style="color:#f92672">.</span>x <span style="color:#f92672">&lt;</span> v2<span style="color:#f92672">.</span>x


<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> lessv_y(v1: <span style="color:#a6e22e">Vector2</span>, v2: <span style="color:#a6e22e">Vector2</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#66d9ef">return</span> v1<span style="color:#f92672">.</span>y <span style="color:#f92672">&lt;</span> v2<span style="color:#f92672">.</span>y


<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> index_to_xy(width: <span style="color:#a6e22e">int</span>, index: <span style="color:#a6e22e">int</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Vector2</span>(index <span style="color:#f92672">%</span> width, index <span style="color:#f92672">/</span> width)
</pre>
<p>Note that we have also added the new function: <code>index_to_xy()</code>. This converts a 1-dimensional <code>index</code> value to a 2-dimensional vector given a grid width. It’s used to convert two nested for loops into one.</p>
<p>Delete the functions with the same names from <code>BasicDungeon.gd</code> and find and replace <code>self</code> with <code>Utils</code> the following line from <code>_add_room()</code>:</p>
<pre style="color:#f8f8f2;background-color:#272822">poly_partial<span style="color:#f92672">.</span>sort_custom(self, <span style="color:#e6db74">&quot;_lessv_x&quot;</span> <span style="color:#66d9ef">if</span> is_even <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&quot;_lessv_y&quot;</span>)
</pre>
<p>with</p>
<pre style="color:#f8f8f2;background-color:#272822">poly_partial<span style="color:#f92672">.</span>sort_custom(Utils, <span style="color:#e6db74">&quot;lessv_x&quot;</span> <span style="color:#66d9ef">if</span> is_even <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&quot;lessv_y&quot;</span>)
</pre>
<p>If you run the project now you shouldn’t see any difference.</p>
<p>Let’s investigate what happened here:</p>
<ul>
<li>We created the new <code>Utils.gd</code> script file and moved a few functions from <code>BasicDungeon.gd</code> into it.</li>
<li>We also used <code>class_name Utils</code> at the very top of <code>Utils.gd</code>. This instructs Godot to register the class in the global namespace. This allows us to call on it directly without having to load it beforehand with <code>preload()</code> or <code>load()</code> functions or VIA autoload project settings.</li>
<li>We also declared the <code>Utils</code> class functions with <code>static</code>. What this means is that we can call on them directly with <code>Utils.index_to_xy()</code> instead of first having to instantiate a new <code>Utils</code> object with <code>Utils.new()</code>.</li>
</ul>
<p>Note that <strong>we can’t call</strong> non-static functions <strong>from static functions</strong> and <strong>we can’t directly access state variables</strong> on the class.</p>
<p>Creating these sort of library classes is beneficial if we want to share reusable functions between projects. The above functions are useful enough to consider doing this.</p>
<h2 id="abstracting-room-data">Abstracting room data</h2>
<p>Our algorithm uses a somewhat complex <code>_add_room()</code> function which could use some simplification. To do that we’ll implement two classes: <code>Room</code> and <code>RoomOrganic</code> which uses inheritance to reuse functionality from <code>Room</code>.</p>
<p>Create the <code>Room.gd</code> file with the following content:</p>
<pre style="color:#f8f8f2;background-color:#272822">class_name <span style="color:#a6e22e">Room</span>


<span style="color:#66d9ef">var</span> position :<span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO <span style="color:#66d9ef">setget</span> _no_op, get_position
<span style="color:#66d9ef">var</span> end :<span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO <span style="color:#66d9ef">setget</span> _no_op, get_end
<span style="color:#66d9ef">var</span> center :<span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO <span style="color:#66d9ef">setget</span> _no_op, get_center
<span style="color:#66d9ef">var</span> rect: <span style="color:#a6e22e">Rect2</span>

<span style="color:#66d9ef">var</span> _rect_area: <span style="color:#a6e22e">float</span>
<span style="color:#66d9ef">var</span> _iter_index: <span style="color:#a6e22e">int</span>


<span style="color:#66d9ef">func</span> _init(rect: <span style="color:#a6e22e">Rect2</span>) <span style="color:#f92672">-&gt;</span> void:
    update(rect)


<span style="color:#66d9ef">func</span> _iter_init(_arg) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    _iter_index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">return</span> _iter_is_running()


<span style="color:#66d9ef">func</span> _iter_next(_arg) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    _iter_index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">return</span> _iter_is_running()


<span style="color:#66d9ef">func</span> _iter_get(_arg) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">var</span> offset :<span style="color:#f92672">=</span> BasicDungeonUtils<span style="color:#f92672">.</span>index_to_xy(rect<span style="color:#f92672">.</span>size<span style="color:#f92672">.</span>x, _iter_index)
    <span style="color:#66d9ef">return</span> rect<span style="color:#f92672">.</span>position <span style="color:#f92672">+</span> offset


<span style="color:#66d9ef">func</span> update(rect: <span style="color:#a6e22e">Rect2</span>) <span style="color:#f92672">-&gt;</span> void:
    self<span style="color:#f92672">.</span>rect <span style="color:#f92672">=</span> rect<span style="color:#f92672">.</span>abs()
    _rect_area <span style="color:#f92672">=</span> rect<span style="color:#f92672">.</span>get_area()


<span style="color:#66d9ef">func</span> intersects(room: <span style="color:#a6e22e">Room</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#66d9ef">return</span> rect<span style="color:#f92672">.</span>intersects(room<span style="color:#f92672">.</span>rect)


<span style="color:#66d9ef">func</span> get_position() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">return</span> rect<span style="color:#f92672">.</span>position


<span style="color:#66d9ef">func</span> get_end() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">return</span> rect<span style="color:#f92672">.</span>end


<span style="color:#66d9ef">func</span> get_center() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> (rect<span style="color:#f92672">.</span>position <span style="color:#f92672">+</span> rect<span style="color:#f92672">.</span>end)


<span style="color:#66d9ef">func</span> _iter_is_running() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#66d9ef">return</span> _iter_index <span style="color:#f92672">&lt;</span> _rect_area


<span style="color:#66d9ef">func</span> _no_op(val) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">pass</span>
</pre>
<p>We have created a wrapper class around <code>Rect2</code> to give us some quality of life improvements in the generator algorithm.</p>
<p>We register the class globally with <code>class_name Room</code>, but in this case we want to create new room objects so the functions aren’t static. It’s a regular object, but it does employ advanced features.</p>
<p>We declare and initialize <code>position</code>, <code>end</code> and <code>center</code> variables with <code>Vector2.ZERO</code> and declaring setters and getters for them. The syntax is:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">var</span> name[[: Type] [<span style="color:#f92672">=</span> initial_value]] [<span style="color:#66d9ef">setget</span> [setter][, getter]]
</pre>
<p>where <code>setter</code> and <code>getter</code> are functions defined in the class and everything in <code>[...]</code> is optional. For example the following are all valid:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">var</span> name <span style="color:#66d9ef">setget</span> only_setter
<span style="color:#66d9ef">var</span> name <span style="color:#66d9ef">setget</span> , only_getter <span style="color:#75715e"># notice the comma</span>
<span style="color:#66d9ef">var</span> name :<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">setget</span> setter, getter
<span style="color:#66d9ef">var</span> name: <span style="color:#a6e22e">int</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">setget</span> setter, getter
</pre>
<p>We finish the variable declarations with:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">var</span> rect: <span style="color:#a6e22e">Rect2</span>

<span style="color:#66d9ef">var</span> _rect_area: <span style="color:#a6e22e">float</span>
<span style="color:#66d9ef">var</span> _iter_index: <span style="color:#a6e22e">int</span>
</pre>
<p>To pass in parameters on creation time of an object we need to declare and implement the constructor function <code>_init()</code>. In this case we have:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _init(rect: <span style="color:#a6e22e">Rect2</span>) <span style="color:#f92672">-&gt;</span> void:
    update(rect)
</pre>
<p>We can then create an object with <code>Room.new(rect)</code> in some other part of our code. We list <code>update()</code> here because it’s relevant to our class functionality:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> update(rect: <span style="color:#a6e22e">Rect2</span>) <span style="color:#f92672">-&gt;</span> void:
    self<span style="color:#f92672">.</span>rect <span style="color:#f92672">=</span> rect<span style="color:#f92672">.</span>abs()
    _rect_area <span style="color:#f92672">=</span> rect<span style="color:#f92672">.</span>get_area()
</pre>
<p>When assigning <code>rect</code> to the state variable <code>self.rect</code> we make sure <code>rect.width</code> and <code>rect.height</code> are positive numbers using <code>Rect2.abs()</code>. We then store the area of the rectangle in the pseudo-private <code>_rect_area</code> class variable since we use it in the custom iterator functions. This is so we don’t calculate <code>rect.get_area()</code> each time Godot invokes the iterator.</p>
<h3 id="custom-iterators">Custom iterators</h3>
<p>A custom iterator class implements the following functions:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _iter_init(_arg: <span style="color:#a6e22e">Array</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#75715e"># ...</span>


<span style="color:#66d9ef">func</span> _iter_next(_arg: <span style="color:#a6e22e">Array</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#75715e"># ...</span>


<span style="color:#66d9ef">func</span> _iter_get(_arg) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#75715e"># ...</span>
</pre>
<p>Our implementations are like this:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _iter_init(_arg) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    _iter_index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">return</span> _iter_is_running()


<span style="color:#66d9ef">func</span> _iter_next(_arg) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    _iter_index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">return</span> _iter_is_running()


<span style="color:#66d9ef">func</span> _iter_get(_arg) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">var</span> offset :<span style="color:#f92672">=</span> Utils<span style="color:#f92672">.</span>index_to_xy(rect<span style="color:#f92672">.</span>size<span style="color:#f92672">.</span>x, _iter_index)
    <span style="color:#66d9ef">return</span> rect<span style="color:#f92672">.</span>position <span style="color:#f92672">+</span> offset


<span style="color:#66d9ef">func</span> _iter_is_running() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#66d9ef">return</span> _iter_index <span style="color:#f92672">&lt;</span> _rect_area
</pre>
<p>Note that the <code>_arg</code> parameter is used internally by Godot and we don’t have much use for it, but it’s mandatory so we have to include it in the declaration.</p>
<p><code>_iter_init()</code> initializes the value for the iterator as the function name implies. This happens every time <code>for ... in room</code> is first encountered. <code>_iter_next()</code> is called on each subsequent iteration while the loop runs. This is where we advance the internal iterator state. Both of these functions return a boolean value instructing Godot to either continue or terminate the for loop. Iteration continues until <code>_iter_next()</code> returns <code>false</code>, assuming <code>_iter_init()</code> returned <code>true</code>.</p>
<p>Note that <code>_iter_is_running()</code> is just an extra custom function that isn’t required for the custom iterator to be implemented.</p>
<p><code>_iter_get()</code> is the function that supplies Godot with the actual iterator value within the for loop. Here, we use <code>Utils.index_to_xy()</code> to get a <code>Vector2</code> based on the 1-dimensional <code>_iter_index</code> value.</p>
<p>Now we can use the class like this:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">var</span> room <span style="color:#f92672">=</span> <span style="color:#a6e22e">Room</span><span style="color:#f92672">.</span>new(rect)
<span style="color:#66d9ef">for</span> point <span style="color:#f92672">in</span> room:
    do_something_with(point)
</pre>
<p>where <code>point</code> is a <code>Vector2</code> coordinate with integer positions (<code>Vector2(2, 1)</code>, <code>Vector2(3, 4)</code> etc.) that spans the entire rectangular area.</p>
<p><code>intersects()</code> delegates the work to the underlying <code>rect</code> state variable.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> intersects(room: <span style="color:#a6e22e">Room</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#66d9ef">return</span> rect<span style="color:#f92672">.</span>intersects(room<span style="color:#f92672">.</span>rect)
</pre>
<h2 id="setters-and-getters">Setters and getters</h2>
<p>Let’s review our implementation for the setters and getters.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> get_position() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">return</span> rect<span style="color:#f92672">.</span>position


<span style="color:#66d9ef">func</span> get_end() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">return</span> rect<span style="color:#f92672">.</span>end


<span style="color:#66d9ef">func</span> get_center() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> (rect<span style="color:#f92672">.</span>position <span style="color:#f92672">+</span> rect<span style="color:#f92672">.</span>end)


<span style="color:#66d9ef">func</span> _no_op(val) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">pass</span>
</pre>
<p>A quick explanation is that:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">var</span> room :<span style="color:#f92672">=</span> <span style="color:#a6e22e">Room</span><span style="color:#f92672">.</span>new(<span style="color:#a6e22e">Rect2</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">10</span>))


<span style="color:#66d9ef">var</span> center <span style="color:#f92672">=</span> room<span style="color:#f92672">.</span>center
<span style="color:#75715e"># is the same as:</span>
<span style="color:#66d9ef">var</span> center :<span style="color:#f92672">=</span> room<span style="color:#f92672">.</span>get_center()


room<span style="color:#f92672">.</span>center <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>)
<span style="color:#75715e"># is the same as:</span>
room<span style="color:#f92672">.</span>set_center(<span style="color:#a6e22e">Vector2</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>))
</pre>
<p>Each time we access a variable defined with getters, for example:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">var</span> center :<span style="color:#f92672">=</span> room<span style="color:#f92672">.</span>center
</pre>
<p>Godot calls the specified getter behind the scenes, <code>get_center()</code> in this case. We have also specified the <code>_no_op()</code> setter so that whenever we use assign a value to one of the variables:</p>
<pre style="color:#f8f8f2;background-color:#272822">room<span style="color:#f92672">.</span>position <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span>(<span style="color:#f92672">...</span>)
</pre>
<p>no assignment actually takes place as Godot calls the given function which does nothing in this case. This is a way to protect our variables from unwanted outside assignments.</p>
<p>Note that we haven’t used type annotation on <code>_no_op()</code>’s parameter. This is so it can be used with any type of variable, not just <code>Vector2</code>, as in our example here.</p>
<p>We’d use setters for example when we might want to emit a signal that a variable has changed, but there are many other uses for them. In the case of <code>room.center</code> variable, we calculate it from <code>rect.position</code> and <code>rect.end</code> internally as <code>Rect2</code> doesn’t provide this member itself.</p>
<h2 id="organic-room-via-inheritance">Organic room via inheritance</h2>
<p>With the core functionality defined in <code>Room.gd</code>, we inherit and expand upon it in <code>RoomOrganic.gd</code>:</p>
<pre style="color:#f8f8f2;background-color:#272822">class_name RoomOrganic
<span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Room</span>


<span style="color:#66d9ef">const</span> FACTOR :<span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">8.0</span>

<span style="color:#66d9ef">var</span> _data: <span style="color:#a6e22e">Array</span>
<span style="color:#66d9ef">var</span> _data_size: <span style="color:#a6e22e">int</span>


<span style="color:#66d9ef">func</span> _init(rect: <span style="color:#a6e22e">Rect2</span>)<span style="color:#f92672">.</span>(rect) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">func</span> _iter_get(_arg) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">return</span> _data[_iter_index]


<span style="color:#66d9ef">func</span> update(rect: <span style="color:#a6e22e">Rect2</span>) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#f92672">.</span>update(rect)
    <span style="color:#66d9ef">var</span> rng :<span style="color:#f92672">=</span> RandomNumberGenerator<span style="color:#f92672">.</span>new()
    rng<span style="color:#f92672">.</span>randomize()

    <span style="color:#66d9ef">var</span> unit :<span style="color:#f92672">=</span> FACTOR <span style="color:#f92672">*</span> rect<span style="color:#f92672">.</span>size
    <span style="color:#66d9ef">var</span> order :<span style="color:#f92672">=</span> [
        rect<span style="color:#f92672">.</span>grow_individual(<span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>x, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>x, unit<span style="color:#f92672">.</span>y <span style="color:#f92672">-</span> rect<span style="color:#f92672">.</span>size<span style="color:#f92672">.</span>y),
        rect<span style="color:#f92672">.</span>grow_individual(unit<span style="color:#f92672">.</span>x <span style="color:#f92672">-</span> rect<span style="color:#f92672">.</span>size<span style="color:#f92672">.</span>x, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>y, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>y),
        rect<span style="color:#f92672">.</span>grow_individual(<span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>x, unit<span style="color:#f92672">.</span>y <span style="color:#f92672">-</span> rect<span style="color:#f92672">.</span>size<span style="color:#f92672">.</span>y, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>x, <span style="color:#ae81ff">0</span>),
        rect<span style="color:#f92672">.</span>grow_individual(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>y, unit<span style="color:#f92672">.</span>x <span style="color:#f92672">-</span> rect<span style="color:#f92672">.</span>size<span style="color:#f92672">.</span>x, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>y)
    ]
    <span style="color:#66d9ef">var</span> poly <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> index <span style="color:#f92672">in</span> range(order<span style="color:#f92672">.</span>size()):
        <span style="color:#66d9ef">var</span> rect_current: <span style="color:#a6e22e">Rect2</span> <span style="color:#f92672">=</span> order[index]
        <span style="color:#66d9ef">var</span> is_even :<span style="color:#f92672">=</span> index <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">var</span> poly_partial :<span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> range(rng<span style="color:#f92672">.</span>randi_range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)):
            poly_partial<span style="color:#f92672">.</span>push_back(<span style="color:#a6e22e">Vector2</span>(
                rng<span style="color:#f92672">.</span>randf_range(rect_current<span style="color:#f92672">.</span>position<span style="color:#f92672">.</span>x, rect_current<span style="color:#f92672">.</span>end<span style="color:#f92672">.</span>x),
                rng<span style="color:#f92672">.</span>randf_range(rect_current<span style="color:#f92672">.</span>position<span style="color:#f92672">.</span>y, rect_current<span style="color:#f92672">.</span>end<span style="color:#f92672">.</span>y)
            ))
        poly_partial<span style="color:#f92672">.</span>sort_custom(Utils, <span style="color:#e6db74">&quot;lessv_x&quot;</span> <span style="color:#66d9ef">if</span> is_even <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&quot;lessv_y&quot;</span>)
        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
            poly_partial<span style="color:#f92672">.</span>invert()
        poly <span style="color:#f92672">+=</span> poly_partial

    _data <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(rect<span style="color:#f92672">.</span>position<span style="color:#f92672">.</span>x, rect<span style="color:#f92672">.</span>end<span style="color:#f92672">.</span>x):
        <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(rect<span style="color:#f92672">.</span>position<span style="color:#f92672">.</span>y, rect<span style="color:#f92672">.</span>end<span style="color:#f92672">.</span>y):
            <span style="color:#66d9ef">var</span> point :<span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span>(x, y)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Geometry</span><span style="color:#f92672">.</span>is_point_in_polygon(point, poly):
                _data<span style="color:#f92672">.</span>push_back(point)
    _data_size <span style="color:#f92672">=</span> _data<span style="color:#f92672">.</span>size()


<span style="color:#66d9ef">func</span> _iter_is_running() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#66d9ef">return</span> _iter_index <span style="color:#f92672">&lt;</span> _data_size
</pre>
<p>We start by registering this class with the name <code>RoomOrganic</code> and inheriting from <code>Room</code>:</p>
<pre style="color:#f8f8f2;background-color:#272822">class_name RoomOrganic
<span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Room</span>
</pre>
<p>Since we rely on custom iterators to go over the contained points within a polygon, we can’t iterate over the entire rectangular area any more. For this we define the following internal variables:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">var</span> _data: <span style="color:#a6e22e">Array</span>
<span style="color:#66d9ef">var</span> _data_size: <span style="color:#a6e22e">int</span>
</pre>
<p>Let’s understand <code>_init()</code> syntax:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _init(rect: <span style="color:#a6e22e">Rect2</span>)<span style="color:#f92672">.</span>(rect) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">pass</span>
</pre>
<p><code>_init(param1: int, param2: Vector2).(param2)</code> is the way to tell Godot the following: I want to define a constructor that accepts two parameters: <code>param1</code> and <code>param2</code>, but I also want you to call the constructor on the parent class sending <code>param2</code> to it.</p>
<p>Note that even if <code>_init()</code> doesn’t have any implementation in this <code>RoomOrganic</code> class, we still have to declare the function with the <code>pass</code> declaration. The following is invalid:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _init(rect: <span style="color:#a6e22e">Rect2</span>) <span style="color:#f92672">-&gt;</span> void:
    update(rect)
</pre>
<p>because we inherit from a class that needs a parameter to be passed in on construction: <code>Room.new(rect)</code>. We are forced to declare: <code>func _init(rect: Rect2).(rect) -&gt; void</code>. We also don’t need to explicitly call <code>update()</code> here since the parent class already does this.</p>
<p>We overwrite <code>_iter_get()</code> and <code>_iter_is_running()</code> to reflect the new data on the polygonal room type:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _iter_get(_arg) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Vector2</span>:
    <span style="color:#66d9ef">return</span> _data[_iter_index]


<span style="color:#66d9ef">func</span> _iter_is_running() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#66d9ef">return</span> _iter_index <span style="color:#f92672">&lt;</span> _data_size
</pre>
<p>The <code>update()</code> function is the implementation of for organic rooms from <code>BasicDungeon</code>’s <code>_add_room()</code>:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> update(rect: <span style="color:#a6e22e">Rect2</span>) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#f92672">.</span>update(rect)
    <span style="color:#66d9ef">var</span> rng :<span style="color:#f92672">=</span> RandomNumberGenerator<span style="color:#f92672">.</span>new()
    rng<span style="color:#f92672">.</span>randomize()

    <span style="color:#66d9ef">var</span> unit :<span style="color:#f92672">=</span> FACTOR <span style="color:#f92672">*</span> rect<span style="color:#f92672">.</span>size
    <span style="color:#66d9ef">var</span> order :<span style="color:#f92672">=</span> [
        rect<span style="color:#f92672">.</span>grow_individual(<span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>x, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>x, unit<span style="color:#f92672">.</span>y <span style="color:#f92672">-</span> rect<span style="color:#f92672">.</span>size<span style="color:#f92672">.</span>y),
        rect<span style="color:#f92672">.</span>grow_individual(unit<span style="color:#f92672">.</span>x <span style="color:#f92672">-</span> rect<span style="color:#f92672">.</span>size<span style="color:#f92672">.</span>x, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>y, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>y),
        rect<span style="color:#f92672">.</span>grow_individual(<span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>x, unit<span style="color:#f92672">.</span>y <span style="color:#f92672">-</span> rect<span style="color:#f92672">.</span>size<span style="color:#f92672">.</span>y, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>x, <span style="color:#ae81ff">0</span>),
        rect<span style="color:#f92672">.</span>grow_individual(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>y, unit<span style="color:#f92672">.</span>x <span style="color:#f92672">-</span> rect<span style="color:#f92672">.</span>size<span style="color:#f92672">.</span>x, <span style="color:#f92672">-</span>unit<span style="color:#f92672">.</span>y)
    ]
    <span style="color:#66d9ef">var</span> poly <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> index <span style="color:#f92672">in</span> range(order<span style="color:#f92672">.</span>size()):
        <span style="color:#66d9ef">var</span> rect_current: <span style="color:#a6e22e">Rect2</span> <span style="color:#f92672">=</span> order[index]
        <span style="color:#66d9ef">var</span> is_even :<span style="color:#f92672">=</span> index <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">var</span> poly_partial :<span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> range(rng<span style="color:#f92672">.</span>randi_range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)):
            poly_partial<span style="color:#f92672">.</span>push_back(<span style="color:#a6e22e">Vector2</span>(
                rng<span style="color:#f92672">.</span>randf_range(rect_current<span style="color:#f92672">.</span>position<span style="color:#f92672">.</span>x, rect_current<span style="color:#f92672">.</span>end<span style="color:#f92672">.</span>x),
                rng<span style="color:#f92672">.</span>randf_range(rect_current<span style="color:#f92672">.</span>position<span style="color:#f92672">.</span>y, rect_current<span style="color:#f92672">.</span>end<span style="color:#f92672">.</span>y)
            ))
        poly_partial<span style="color:#f92672">.</span>sort_custom(Utils, <span style="color:#e6db74">&quot;lessv_x&quot;</span> <span style="color:#66d9ef">if</span> is_even <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&quot;lessv_y&quot;</span>)
        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
            poly_partial<span style="color:#f92672">.</span>invert()
        poly <span style="color:#f92672">+=</span> poly_partial

    _data <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(rect<span style="color:#f92672">.</span>position<span style="color:#f92672">.</span>x, rect<span style="color:#f92672">.</span>end<span style="color:#f92672">.</span>x):
        <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(rect<span style="color:#f92672">.</span>position<span style="color:#f92672">.</span>y, rect<span style="color:#f92672">.</span>end<span style="color:#f92672">.</span>y):
            <span style="color:#66d9ef">var</span> point :<span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span>(x, y)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Geometry</span><span style="color:#f92672">.</span>is_point_in_polygon(point, poly):
                _data<span style="color:#f92672">.</span>push_back(point)
    _data_size <span style="color:#f92672">=</span> _data<span style="color:#f92672">.</span>size()
</pre>
<p>The differences are:</p>
<ul>
<li>We call <code>.update(rect)</code> which calls the <code>update()</code> function on the parent class. Note the <code>.</code> (dot) character at the beginning of the function call.</li>
<li>We now save the polygon data in the internal <code>_data</code> pseudo-variable which is used in our custom iterator function.</li>
<li>We also store <code>_data.size()</code> in <code>_data_size</code> pseudo-variable so whenever Godot calls upon the iterator the size doesn’t have to be calculated each time.</li>
</ul>
<p>This concludes our custom room implementations for rectangular and organic types.</p>
<h3 id="using-the-room-classes">Using the room classes</h3>
<p>Now we’re ready to simplify the dungeon generator a bit. Let’s start with the simplest modification. Replace <code>_add_room()</code> with:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _add_room(data: <span style="color:#a6e22e">Dictionary</span>, rooms: <span style="color:#a6e22e">Array</span>, room: <span style="color:#a6e22e">Room</span>) <span style="color:#f92672">-&gt;</span> void:
    rooms<span style="color:#f92672">.</span>push_back(room)
    <span style="color:#66d9ef">for</span> point <span style="color:#f92672">in</span> room:
        data[point] <span style="color:#f92672">=</span> null
</pre>
<p>We take full advantage of our new classes here:</p>
<ul>
<li>The custom iterator we have prepared in our <code>Room</code> and <code>RoomOrganic</code> classes.</li>
<li>We can safely pass in an organic room variable to the function because <code>RoomOrganic</code> is a sub-class of <code>Room</code>.</li>
</ul>
<p>But if you try to run the project right now it won’t work just yet. We still need to replace all <code>Rect2</code> type declarations with <code>Room</code> declarations and do a few other small changes:</p>
<ul>
<li>Replace the <code>_add_room()</code> call: <code>_add_room(rng, data, rooms, room)</code> with <code>_add_room(data, rooms, room)</code> since we don’t need to pass the <code>RandomNumberGenerator</code> any longer.</li>
<li>Replace all occurrences of <code>: Rect2</code> with <code>: Room</code> instead. You can do this with <kbd>Ctrl</kbd> <kbd>r</kbd>.</li>
<li>Update <code>_add_connection()</code> and <code>_get_random_room()</code> with:</li>
</ul>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _add_connection(rng: RandomNumberGenerator, data: <span style="color:#a6e22e">Dictionary</span>, room1: <span style="color:#a6e22e">Room</span>, room2: <span style="color:#a6e22e">Room</span>) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">if</span> rng<span style="color:#f92672">.</span>randi_range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        _add_corridor(data, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>AXIS_X)
        _add_corridor(data, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>AXIS_Y)
    <span style="color:#66d9ef">else</span>:
        _add_corridor(data, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>AXIS_Y)
        _add_corridor(data, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>AXIS_X)


<span style="color:#66d9ef">func</span> _get_random_room(level_size: <span style="color:#a6e22e">Vector2</span>, rooms_size: <span style="color:#a6e22e">Vector2</span>, rng: RandomNumberGenerator) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Room</span>:
    <span style="color:#66d9ef">var</span> width :<span style="color:#f92672">=</span> rng<span style="color:#f92672">.</span>randi_range(rooms_size<span style="color:#f92672">.</span>x, rooms_size<span style="color:#f92672">.</span>y)
    <span style="color:#66d9ef">var</span> height :<span style="color:#f92672">=</span> rng<span style="color:#f92672">.</span>randi_range(rooms_size<span style="color:#f92672">.</span>x, rooms_size<span style="color:#f92672">.</span>y)
    <span style="color:#66d9ef">var</span> x :<span style="color:#f92672">=</span> rng<span style="color:#f92672">.</span>randi_range(<span style="color:#ae81ff">0</span>, level_size<span style="color:#f92672">.</span>x <span style="color:#f92672">-</span> width <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">var</span> y :<span style="color:#f92672">=</span> rng<span style="color:#f92672">.</span>randi_range(<span style="color:#ae81ff">0</span>, level_size<span style="color:#f92672">.</span>y <span style="color:#f92672">-</span> height <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">var</span> rect :<span style="color:#f92672">=</span> <span style="color:#a6e22e">Rect2</span>(x, y, width, height)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Room</span><span style="color:#f92672">.</span>new(rect) <span style="color:#66d9ef">if</span> rng<span style="color:#f92672">.</span>randi_range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> Organic<span style="color:#f92672">.</span>new(rect)
</pre>
<p>Now we should be able to run the project without any problem.</p>
<p>We didn’t simplify the algorithm a hole lot, but we did learn a few tricks.</p>
<h2 id="a-reusable-dungeon-generator">A reusable dungeon generator</h2>
<p>As a final exercise let’s separate the dungeon generator algorithm from the rendering algorithm.</p>
<p>Create <code>Generator.gd</code> with the following content:</p>
<pre style="color:#f8f8f2;background-color:#272822">class_name Generator


<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> generate(level_size: <span style="color:#a6e22e">Vector2</span>, rooms_size: <span style="color:#a6e22e">Vector2</span>, rooms_max: <span style="color:#a6e22e">int</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Array</span>:
    <span style="color:#66d9ef">var</span> rng :<span style="color:#f92672">=</span> RandomNumberGenerator<span style="color:#f92672">.</span>new()
    rng<span style="color:#f92672">.</span>randomize()

    <span style="color:#66d9ef">var</span> data :<span style="color:#f92672">=</span> {}
    <span style="color:#66d9ef">var</span> rooms :<span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> range(rooms_max):
        <span style="color:#66d9ef">var</span> room :<span style="color:#f92672">=</span> _get_random_room(level_size, rooms_size, rng)
        <span style="color:#66d9ef">if</span> _intersects(rooms, room):
            <span style="color:#66d9ef">continue</span>

        _add_room(data, rooms, room)
        <span style="color:#66d9ef">if</span> rooms<span style="color:#f92672">.</span>size() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
            <span style="color:#66d9ef">var</span> room_previous: <span style="color:#a6e22e">Room</span> <span style="color:#f92672">=</span> rooms[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>]
            _add_connection(rng, data, room_previous, room)
    <span style="color:#66d9ef">return</span> data<span style="color:#f92672">.</span>keys()


<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> _get_random_room(level_size: <span style="color:#a6e22e">Vector2</span>, rooms_size: <span style="color:#a6e22e">Vector2</span>, rng: RandomNumberGenerator) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Room</span>:
    <span style="color:#66d9ef">var</span> width :<span style="color:#f92672">=</span> rng<span style="color:#f92672">.</span>randi_range(rooms_size<span style="color:#f92672">.</span>x, rooms_size<span style="color:#f92672">.</span>y)
    <span style="color:#66d9ef">var</span> height :<span style="color:#f92672">=</span> rng<span style="color:#f92672">.</span>randi_range(rooms_size<span style="color:#f92672">.</span>x, rooms_size<span style="color:#f92672">.</span>y)
    <span style="color:#66d9ef">var</span> x :<span style="color:#f92672">=</span> rng<span style="color:#f92672">.</span>randi_range(<span style="color:#ae81ff">0</span>, level_size<span style="color:#f92672">.</span>x <span style="color:#f92672">-</span> width <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">var</span> y :<span style="color:#f92672">=</span> rng<span style="color:#f92672">.</span>randi_range(<span style="color:#ae81ff">0</span>, level_size<span style="color:#f92672">.</span>y <span style="color:#f92672">-</span> height <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">var</span> rect :<span style="color:#f92672">=</span> <span style="color:#a6e22e">Rect2</span>(x, y, width, height)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Room</span><span style="color:#f92672">.</span>new(rect) <span style="color:#66d9ef">if</span> rng<span style="color:#f92672">.</span>randi_range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> RoomOrganic<span style="color:#f92672">.</span>new(rect)


<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> _add_room(data: <span style="color:#a6e22e">Dictionary</span>, rooms: <span style="color:#a6e22e">Array</span>, room: <span style="color:#a6e22e">Room</span>) <span style="color:#f92672">-&gt;</span> void:
    rooms<span style="color:#f92672">.</span>push_back(room)
    <span style="color:#66d9ef">for</span> point <span style="color:#f92672">in</span> room:
        data[point] <span style="color:#f92672">=</span> null


<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> _add_connection(rng: RandomNumberGenerator, data: <span style="color:#a6e22e">Dictionary</span>, room1: <span style="color:#a6e22e">Room</span>, room2: <span style="color:#a6e22e">Room</span>) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">if</span> rng<span style="color:#f92672">.</span>randi_range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        _add_corridor(data, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>AXIS_X)
        _add_corridor(data, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>AXIS_Y)
    <span style="color:#66d9ef">else</span>:
        _add_corridor(data, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>AXIS_Y)
        _add_corridor(data, room1<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>x, room2<span style="color:#f92672">.</span>center<span style="color:#f92672">.</span>y, <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>AXIS_X)


<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> _add_corridor(data: <span style="color:#a6e22e">Dictionary</span>, start: <span style="color:#a6e22e">int</span>, end: <span style="color:#a6e22e">int</span>, constant: <span style="color:#a6e22e">int</span>, axis: <span style="color:#a6e22e">int</span>) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> range(min(start, end), max(start, end) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
        <span style="color:#66d9ef">var</span> point :<span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO
        match axis:
            <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>AXIS_X: point <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span>(t, constant)
            <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>AXIS_Y: point <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span>(constant, t)
        data[point] <span style="color:#f92672">=</span> null


<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> _intersects(rooms: <span style="color:#a6e22e">Array</span>, room: <span style="color:#a6e22e">Room</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#66d9ef">var</span> out :<span style="color:#f92672">=</span> false
    <span style="color:#66d9ef">for</span> room_other <span style="color:#f92672">in</span> rooms:
        <span style="color:#66d9ef">if</span> room<span style="color:#f92672">.</span>intersects(room_other):
            out <span style="color:#f92672">=</span> true
            <span style="color:#66d9ef">break</span>
    <span style="color:#66d9ef">return</span> out
</pre>
<p>And update <code>_generator()</code> from <code>BasicDungeon.gd</code> with:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _generate() <span style="color:#f92672">-&gt;</span> void:
    level<span style="color:#f92672">.</span>clear()
    <span style="color:#66d9ef">for</span> vector <span style="color:#f92672">in</span> Generator<span style="color:#f92672">.</span>generate(level_size, rooms_size, rooms_max):
        level<span style="color:#f92672">.</span>set_cellv(vector, <span style="color:#ae81ff">0</span>)
</pre>
<p>All we did here is to group our dungeon algorithm-related functions under a class called <code>Generator</code> using static functions. This way we could create different algorithms and call them depending on our needs.</p>
<p>Since we can store the registered class itself into variables we can do something like:</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">var</span> algorithm :<span style="color:#f92672">=</span> Generator
<span style="color:#66d9ef">for</span> vector <span style="color:#f92672">in</span> algorithm<span style="color:#f92672">.</span>generate(level_size, room_size, rooms_max):
    <span style="color:#75715e"># ...</span>
</pre>
<p>With this we conclude our tutorial on reusability and advanced GDScript features.</p>
</body>
</html>
