<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>TmpoOVhMvKfAg</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <style type="text/css">:root {--c-caption: grey;--c-blue: #26bfe3;--c-green: #02e180;--c-orange: #f2971a;--c-pink: #e3266f;--c-bg: #fff;--c-bg-alt: #f5f5f5;--c-text-header: #fff;--c-text-body: #95989a;--padding: 20px;--padding-inv: calc(-1 * var(--padding));--fonts: "Open Sans", -apple-system, system-ui, "Segoe UI", "Roboto","Helvetica Neue", Arial, sans-serif;--font-size: 1.1rem;}html {font-size: 100%;}body {color: #444;font-family: var(--fonts);font-size: var(--font-size);line-height: 1.7;padding: 1em;margin: auto;max-width: 800px;background: #fefefe;}a {color: #0645ad;text-decoration: none;}a:visited {color: #0b0080;}a:hover {color: #06e;}a:active {color: #faa700;}a:focus {outline: thin dotted;}a::selection {background: rgba(255, 255, 0, 0.3);color: #0645ad;}*::selection {background: rgba(255, 255, 0, 0.3);color: #000;}p {margin: 1em 0;}.caption {text-align: center;color: var(--c-caption);font-style: italic;}.note,.tips,.warning {display: block;width: calc(100% - var(--padding) * 2);padding: 0 var(--padding);padding-bottom: var(--padding);background-color: var(--c-bg-alt);}.note:before,.tips:before,.warning:before {display: block;margin: 0 var(--padding-inv) 10px var(--padding-inv);padding-left: var(--padding);font-style: bold;color: white;}.note:before {content: "Note";background-color: var(--c-blue);}.tips:before {content: "Tips";background-color: var(--c-pink);}.warning:before {content: "Warning";background-color: var(--c-orange);}img {max-width: 100%;}h1,h2,h3,h4,h5,h6 {color: #111;line-height: 125%;margin-top: 2em;font-weight: normal;}h4,h5,h6 {font-weight: bold;}h1 {font-size: 2.5em;}h2 {font-size: 2em;}h3 {font-size: 1.5em;}h4 {font-size: 1.2em;}blockquote {color: #666666;margin: 0;padding-left: 3em;border-left: 0.5em #eee solid;}hr {display: block;height: 2px;border: 0;border-top: 1px solid #aaa;border-bottom: 1px solid #eee;margin: 1em 0;padding: 0;}pre,code,kbd,samp {color: #0084b8;font-family: monospace, monospace;}pre {background-color: #f9f9f9;padding: 1em;font-size: 14px;white-space: pre-wrap;word-wrap: break-word;}code {white-space: pre-wrap;}b,strong {font-weight: bold;}dfn {font-style: italic;color: var(--c-blue);}ins {background: #ff9;color: #000;text-decoration: none;}ul,ol {margin: 1em 0;padding: 0 0 0 2em;}li p:last-child {margin-bottom: 0;}ul ul,ol ol {margin: 0.3em 0;}dl {margin-bottom: 1em;}dt {font-weight: bold;margin-bottom: 0.8em;}dd {margin: 0 0 0.8em 2em;}dd:last-child {margin-bottom: 0;}img {border: 0;-ms-interpolation-mode: bicubic;vertical-align: middle;}figure {display: block;text-align: center;margin: 1em 0;}figure img {border: none;margin: 0 auto;}figcaption {font-size: 0.8em;font-style: italic;margin: 0 0 0.8em;}.author {font-size: 1.2em;text-align: center;}tag {min-width: 3.2em;text-align: center;border-radius: 8px;padding: 0 4px;margin-bottom: 0;margin-top: 4px;margin-right: 0.2em;display: inline-block;color: white;}tag.update {background: var(--c-blue);}tag.new {background: var(--c-green);}tag.update:after {content: "update";}tag.new:after {content: "new";}button {background-color: var(--c-blue);color: white;border: none;cursor: pointer;line-height: 2rem;font-size: 1.2rem;margin: 0.75rem 0;overflow: visible;padding: 0.75rem 1.5rem;border-radius: 1rem;transition: background-color $transition-duration;white-space: nowrap;}</style>
</head>
<body>
<h1 id="toon-proxy-builder-part-one">Toon proxy builder, part one</h1>
<p>The scene builder builds the <code>Viewport</code>s while the proxy builder creates duplicates controlled with <code>RemoteControl</code> nodes. We call these the proxies.</p>
<p>In this chapter, we’ll make the proxy builder to create proxies and remote transforms.</p>
<h2 id="building-the-proxy-builder">Building the proxy builder</h2>
<p>Add a <code>MeshInstance</code> to the scene and assign it a sphere. We use that as a guinea pig to develop the add on with.</p>
<p>Add a new <code>Node</code> to the mesh and assign it a script. Save it in <code>addons/gdquest.toon-controller/Tools/ToonProxyBuilder.gd</code>.</p>
<p>It’s an editor script so needs the <code>tool</code> keyword. We give it a class so Godot adds it to the <em>Add Node</em> dialog. Since it’s inside the addons folder, Godot will list it when the plugin is activate but not before.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">tool</span>
class_name ToonProxyBuilder
<span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Node</span>
</pre>
<h2 id="data">Data</h2>
<p>When assigned to lights, the proxy keeps track of what kind of light the parent is (key, fill or kick) using an enum. We add a setter since it has to change data on the proxy lights.</p>
<p>It stores whether a light should emit shadows.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">enum</span> LightRole { KEY, FILL, KICK }

<span style="color:#66d9ef">export</span> (LightRole) <span style="color:#66d9ef">var</span> light_role :<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">setget</span> _set_light_role
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">var</span> emits_shadows :<span style="color:#f92672">=</span> false <span style="color:#66d9ef">setget</span> _set_emits_shadows


<span style="color:#66d9ef">func</span> _set_light_role(value: <span style="color:#a6e22e">int</span>) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">func</span> _set_emits_shadows(value: <span style="color:#a6e22e">bool</span>) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">pass</span>
</pre>
<p>It also holds a reference to the proxies and <code>RemoteTransform</code> nodes it creates.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">var</span> light_proxy: <span style="color:#a6e22e">Node</span>
<span style="color:#66d9ef">var</span> specular_proxy: <span style="color:#a6e22e">Node</span>

<span style="color:#66d9ef">var</span> light_remote: RemoteTransform
<span style="color:#66d9ef">var</span> specular_remote: RemoteTransform
</pre>
<h2 id="initialization">Initialization</h2>
<p>It first finds the scene root and the <code>ToonSceneBuilder</code>, as it depends on it to find viewports and data.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> scene_root: <span style="color:#a6e22e">Node</span> <span style="color:#f92672">=</span> (
    get_tree()<span style="color:#f92672">.</span>edited_scene_root
    <span style="color:#66d9ef">if</span> Engine<span style="color:#f92672">.</span>editor_hint
    <span style="color:#66d9ef">else</span> get_tree()<span style="color:#f92672">.</span>root
)
<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> builder: ToonSceneBuilder <span style="color:#f92672">=</span> scene_root<span style="color:#f92672">.</span>find_node(<span style="color:#e6db74">&quot;ToonSceneBuilder&quot;</span>)


<span style="color:#66d9ef">func</span> _ready():
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> builder:
        <span style="color:#66d9ef">return</span>
</pre>
<p>It first grabs its parent, and uses its name to find its proxies on the light and specular viewports. Note the use of the optional boolean in <code>find_node</code>. The first defaults to true and uses a recursive search, but the second is false because the viewports <em>do not</em> own the proxies (the scene root does).</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">var</span> parent :<span style="color:#f92672">=</span> get_parent()

light_proxy <span style="color:#f92672">=</span> builder<span style="color:#f92672">.</span>light_data<span style="color:#f92672">.</span>find_node(parent<span style="color:#f92672">.</span>name, true, false)
specular_proxy <span style="color:#f92672">=</span> builder<span style="color:#f92672">.</span>specular_data<span style="color:#f92672">.</span>find_node(parent<span style="color:#f92672">.</span>name, true, false)
</pre>
<p>If they’re missing <em>and</em> we’re in the editor, we build them. We create a function <code>_build_missing_proxies</code> which takes the parent as its argument.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _build_missing_proxies(parent: <span style="color:#a6e22e">Node</span>) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">var</span> light_missing: <span style="color:#a6e22e">bool</span> <span style="color:#f92672">=</span> light_proxy <span style="color:#f92672">==</span> null
    <span style="color:#66d9ef">var</span> specular_missing: <span style="color:#a6e22e">bool</span> <span style="color:#f92672">=</span> specular_proxy <span style="color:#f92672">==</span> null
</pre>
<p>If either of them are missing, we remove the proxy from the object. Otherwise, it would get duplicated and the proxy code would run again until Godot either crashes or detects an error! We add it again once we’re done.</p>
<p>Note the call to <code>yield</code> before we start messing around with hierarchy. When you add the node directly from the <em>Add Child Node</em> dialog, the hierarchy is already established and there’s no issue. But when loading the scene, Godot is busy setting children up and it would throw errors. We wait a frame for it to finish before proceeding.</p>
<pre style="color:#f8f8f2;background-color:#272822">yield(get_tree(), <span style="color:#e6db74">&quot;idle_frame&quot;</span>)

<span style="color:#66d9ef">if</span> light_missing <span style="color:#f92672">or</span> specular_missing:
    parent<span style="color:#f92672">.</span>remove_child(self)
</pre>
<p>When one of the proxies is missing, we need to build and configure it. For that, we build yet another function <code>_build_remote_duplicates</code> which takes the parent and the viewport. It returns a duplicate node and a <code>RemoteTransform</code> inside a <code>Dictionary</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> _build_remote_duplicates(parent: <span style="color:#a6e22e">Node</span>, type: <span style="color:#a6e22e">int</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Dictionary</span>:
    <span style="color:#66d9ef">var</span> proxy: <span style="color:#a6e22e">Node</span> <span style="color:#f92672">=</span> parent<span style="color:#f92672">.</span>duplicate()
    <span style="color:#66d9ef">var</span> proxy_remote :<span style="color:#f92672">=</span> RemoteTransform<span style="color:#f92672">.</span>new()

    parent<span style="color:#f92672">.</span>add_child(proxy_remote)
    proxy_remote<span style="color:#f92672">.</span>owner <span style="color:#f92672">=</span> scene_root
</pre>
<p>We name the remote and add the proxy as a child to the correct viewport based on the data type we specify. We also set the initial color of any light to red since the default is the key light. The setter is what changes it to fill or kick.</p>
<pre style="color:#f8f8f2;background-color:#272822">match type:
    ToonSceneBuilder<span style="color:#f92672">.</span>DataType<span style="color:#f92672">.</span>LIGHT:
        builder<span style="color:#f92672">.</span>light_data<span style="color:#f92672">.</span>add_child(proxy)
        <span style="color:#66d9ef">if</span> proxy is <span style="color:#a6e22e">Light</span>:
            proxy<span style="color:#f92672">.</span>light_color <span style="color:#f92672">=</span> <span style="color:#a6e22e">Color</span><span style="color:#f92672">.</span>red
        proxy_remote<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&quot;LightRemote&quot;</span>
    ToonSceneBuilder<span style="color:#f92672">.</span>DataType<span style="color:#f92672">.</span>SPECULAR:
        builder<span style="color:#f92672">.</span>specular_data<span style="color:#f92672">.</span>add_child(proxy)
        proxy_remote<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&quot;SpecularRemote&quot;</span>

proxy<span style="color:#f92672">.</span>owner <span style="color:#f92672">=</span> scene_root
</pre>
<p>We set the remote’s <code>remote_path</code>, and then return the proxy and the remote in a dictionary.</p>
<pre style="color:#f8f8f2;background-color:#272822">proxy_remote<span style="color:#f92672">.</span>remote_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&quot;../</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&quot;</span> <span style="color:#f92672">%</span> parent<span style="color:#f92672">.</span>get_path_to(proxy)

<span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&quot;proxy&quot;</span>: proxy, <span style="color:#e6db74">&quot;proxy_remote&quot;</span>: proxy_remote}
</pre>
<p>Back in <strong><code>_build_missing_proxies</code></strong>, we call this new function for the missing light and specular, and extract the information into the proxy and remote variables. If they’re <em>not</em> missing, we just grab the remote by name.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">if</span> light_missing:
    <span style="color:#66d9ef">var</span> result :<span style="color:#f92672">=</span> _build_remote_duplicates(
        parent, ToonSceneBuilder<span style="color:#f92672">.</span>DataType<span style="color:#f92672">.</span>LIGHT
    )

    light_proxy <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>proxy
    light_remote <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>proxy_remote
<span style="color:#66d9ef">else</span>:
    light_remote <span style="color:#f92672">=</span> parent<span style="color:#f92672">.</span>find_node(<span style="color:#e6db74">&quot;LightRemote&quot;</span>, true, false)

<span style="color:#66d9ef">if</span> specular_missing:
    <span style="color:#66d9ef">var</span> result :<span style="color:#f92672">=</span> _build_remote_duplicates(
        parent, ToonSceneBuilder<span style="color:#f92672">.</span>DataType<span style="color:#f92672">.</span>SPECULAR
    )

    specular_proxy <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>proxy
    specular_remote <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>proxy_remote
<span style="color:#66d9ef">else</span>:
    specular_remote <span style="color:#f92672">=</span> parent<span style="color:#f92672">.</span>find_node(<span style="color:#e6db74">&quot;SpecularRemote&quot;</span>, true, false)
</pre>
<p>If the light or specular were missing, we re-add the builder to the parent.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">if</span> light_missing <span style="color:#f92672">or</span> specular_missing:
    parent<span style="color:#f92672">.</span>add_child(self)
    owner <span style="color:#f92672">=</span> scene_root
</pre>
<p>Now, go back to <strong><code>_ready</code></strong> to finally call the <code>_build_missing_proxies</code> function.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">if</span> Engine<span style="color:#f92672">.</span>editor_hint:
    _build_missing_proxies(parent)
</pre>
</body>
</html>
