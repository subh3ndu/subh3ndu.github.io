<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Tmp3XC4yHWT7a</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <style type="text/css">:root {--c-caption: grey;--c-blue: #26bfe3;--c-green: #02e180;--c-orange: #f2971a;--c-pink: #e3266f;--c-bg: #fff;--c-bg-alt: #f5f5f5;--c-text-header: #fff;--c-text-body: #95989a;--padding: 20px;--padding-inv: calc(-1 * var(--padding));--fonts: "Open Sans", -apple-system, system-ui, "Segoe UI", "Roboto","Helvetica Neue", Arial, sans-serif;--font-size: 1.1rem;}html {font-size: 100%;}body {color: #444;font-family: var(--fonts);font-size: var(--font-size);line-height: 1.7;padding: 1em;margin: auto;max-width: 800px;background: #fefefe;}a {color: #0645ad;text-decoration: none;}a:visited {color: #0b0080;}a:hover {color: #06e;}a:active {color: #faa700;}a:focus {outline: thin dotted;}a::selection {background: rgba(255, 255, 0, 0.3);color: #0645ad;}*::selection {background: rgba(255, 255, 0, 0.3);color: #000;}p {margin: 1em 0;}.caption {text-align: center;color: var(--c-caption);font-style: italic;}.note,.tips,.warning {display: block;width: calc(100% - var(--padding) * 2);padding: 0 var(--padding);padding-bottom: var(--padding);background-color: var(--c-bg-alt);}.note:before,.tips:before,.warning:before {display: block;margin: 0 var(--padding-inv) 10px var(--padding-inv);padding-left: var(--padding);font-style: bold;color: white;}.note:before {content: "Note";background-color: var(--c-blue);}.tips:before {content: "Tips";background-color: var(--c-pink);}.warning:before {content: "Warning";background-color: var(--c-orange);}img {max-width: 100%;}h1,h2,h3,h4,h5,h6 {color: #111;line-height: 125%;margin-top: 2em;font-weight: normal;}h4,h5,h6 {font-weight: bold;}h1 {font-size: 2.5em;}h2 {font-size: 2em;}h3 {font-size: 1.5em;}h4 {font-size: 1.2em;}blockquote {color: #666666;margin: 0;padding-left: 3em;border-left: 0.5em #eee solid;}hr {display: block;height: 2px;border: 0;border-top: 1px solid #aaa;border-bottom: 1px solid #eee;margin: 1em 0;padding: 0;}pre,code,kbd,samp {color: #0084b8;font-family: monospace, monospace;}pre {background-color: #f9f9f9;padding: 1em;font-size: 14px;white-space: pre-wrap;word-wrap: break-word;}code {white-space: pre-wrap;}b,strong {font-weight: bold;}dfn {font-style: italic;color: var(--c-blue);}ins {background: #ff9;color: #000;text-decoration: none;}ul,ol {margin: 1em 0;padding: 0 0 0 2em;}li p:last-child {margin-bottom: 0;}ul ul,ol ol {margin: 0.3em 0;}dl {margin-bottom: 1em;}dt {font-weight: bold;margin-bottom: 0.8em;}dd {margin: 0 0 0.8em 2em;}dd:last-child {margin-bottom: 0;}img {border: 0;-ms-interpolation-mode: bicubic;vertical-align: middle;}figure {display: block;text-align: center;margin: 1em 0;}figure img {border: none;margin: 0 auto;}figcaption {font-size: 0.8em;font-style: italic;margin: 0 0 0.8em;}.author {font-size: 1.2em;text-align: center;}tag {min-width: 3.2em;text-align: center;border-radius: 8px;padding: 0 4px;margin-bottom: 0;margin-top: 4px;margin-right: 0.2em;display: inline-block;color: white;}tag.update {background: var(--c-blue);}tag.new {background: var(--c-green);}tag.update:after {content: "update";}tag.new:after {content: "new";}button {background-color: var(--c-blue);color: white;border: none;cursor: pointer;line-height: 2rem;font-size: 1.2rem;margin: 0.75rem 0;overflow: visible;padding: 0.75rem 1.5rem;border-radius: 1rem;transition: background-color $transition-duration;white-space: nowrap;}</style>
</head>
<body>
<h1 id="solution-stat-multipliers">Solution: stat multipliers</h1>
<p>Here is a simple solution to the problem that builds upon our code. Assuming we’re not late in development and using the modifier system all around our codebase, I’ve decided to replace the method <code>add_modifier()</code> with two specialized ones: <code>add_value_modifier()</code> and <code>add_rate_modifier()</code>. They both call the now pseudo-private <code>_add_modifier()</code>.</p>
<p>All the code below is an update on <code>BattlerStats.gd</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#75715e"># Initializes keys in the modifiers dict, ensuring they all exist.</span>
<span style="color:#66d9ef">func</span> _init() <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">for</span> stat <span style="color:#f92672">in</span> UPGRADABLE_STATS:
        _modifiers[stat] <span style="color:#f92672">=</span> {
            <span style="color:#75715e"># Each stat now have two dictionaries, `value` and `rate`, to later make it easy </span>
            <span style="color:#75715e"># to calculate final stats.</span>
            value <span style="color:#f92672">=</span> {},
            rate <span style="color:#f92672">=</span> {}
        }

<span style="color:#75715e"># Adds a value-based modifier. The value gets added to the stat `stat_name` after applying</span>
<span style="color:#75715e"># rate-based modifiers.</span>
<span style="color:#66d9ef">func</span> add_value_modifier(stat_name: <span style="color:#a6e22e">String</span>, value: <span style="color:#a6e22e">float</span>) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#75715e"># I miss some features from languages like Python here, that would allow for a more explicit </span>
    <span style="color:#75715e"># syntax.</span>
    _add_modifier(stat_name, value, <span style="color:#ae81ff">0.0</span>)


<span style="color:#75715e"># Adds a rate-based modifier. A value of `0.2` represents an increase in 20% of the stat `stat_name`.</span>
<span style="color:#66d9ef">func</span> add_rate_modifier(stat_name: <span style="color:#a6e22e">String</span>, rate: <span style="color:#a6e22e">float</span>) <span style="color:#f92672">-&gt;</span> void:
    _add_modifier(stat_name, <span style="color:#ae81ff">0.0</span>, rate)


<span style="color:#75715e"># Adds either a value-based or a rate-based modifier. Notice I&#39;m using a third argument with a </span>
<span style="color:#75715e"># default value of `0.0`.</span>
<span style="color:#66d9ef">func</span> _add_modifier(stat_name: <span style="color:#a6e22e">String</span>, value: <span style="color:#a6e22e">float</span>, rate :<span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">int</span>:
    assert(stat_name <span style="color:#f92672">in</span> UPGRADABLE_STATS, <span style="color:#e6db74">&quot;Trying to add a modifier to a nonexistent stat.&quot;</span>)
    <span style="color:#66d9ef">var</span> id :<span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

    <span style="color:#75715e"># If the argument `value` is not `0.0`, we register a value-based modifier.</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> is_equal_approx(value, <span style="color:#ae81ff">0.0</span>):
        <span style="color:#75715e"># Generates a new unique id for the &quot;value&quot; key.</span>
        id <span style="color:#f92672">=</span> _generate_unique_id(stat_name, true)
        _modifiers[stat_name][<span style="color:#e6db74">&quot;value&quot;</span>][id] <span style="color:#f92672">=</span> value
    <span style="color:#75715e"># If the argument `value` is not `0.0`, we register a rate-based modifier.</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> is_equal_approx(rate, <span style="color:#ae81ff">0.0</span>):
        <span style="color:#75715e"># Generates a new unique id for the &quot;rate&quot; key.</span>
        id <span style="color:#f92672">=</span> _generate_unique_id(stat_name, false)
        _modifiers[stat_name][<span style="color:#e6db74">&quot;rate&quot;</span>][id] <span style="color:#f92672">=</span> rate

    _recalculate_and_update(stat_name)
    <span style="color:#66d9ef">return</span> id


<span style="color:#66d9ef">func</span> _recalculate_and_update(stat: <span style="color:#a6e22e">String</span>) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">var</span> value: <span style="color:#a6e22e">float</span> <span style="color:#f92672">=</span> get(<span style="color:#e6db74">&quot;base_&quot;</span> <span style="color:#f92672">+</span> stat)

    <span style="color:#75715e"># We first get and sum all rate-based multipliers.</span>
    <span style="color:#66d9ef">var</span> modifiers_multiplier: <span style="color:#a6e22e">Array</span> <span style="color:#f92672">=</span> _modifiers[stat][<span style="color:#e6db74">&quot;rate&quot;</span>]<span style="color:#f92672">.</span>values()
    <span style="color:#66d9ef">var</span> multiplier :<span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>
    <span style="color:#66d9ef">for</span> modifier <span style="color:#f92672">in</span> modifiers_multiplier:
        multiplier <span style="color:#f92672">+=</span> modifier
    <span style="color:#75715e"># Then, we multiply the base stat&#39;s value, if necessary.</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> is_equal_approx(multiplier, <span style="color:#ae81ff">1.0</span>):
        value <span style="color:#f92672">*=</span> multiplier

    <span style="color:#75715e"># And we add all value-based modifiers.</span>
    <span style="color:#66d9ef">var</span> modifiers_value: <span style="color:#a6e22e">Array</span> <span style="color:#f92672">=</span> _modifiers[stat][<span style="color:#e6db74">&quot;value&quot;</span>]<span style="color:#f92672">.</span>values()
    <span style="color:#66d9ef">for</span> modifier <span style="color:#f92672">in</span> modifiers_value:
        value <span style="color:#f92672">+=</span> modifier

    value <span style="color:#f92672">=</span> round(max(value, <span style="color:#ae81ff">0.0</span>))
    set(stat, value)


<span style="color:#66d9ef">func</span> _generate_unique_id(stat_name: <span style="color:#a6e22e">String</span>, is_value_modifier: <span style="color:#a6e22e">bool</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">int</span>:
    <span style="color:#75715e"># We now use a boolean to pick the right key and generate a corresponding id.</span>
    <span style="color:#66d9ef">var</span> type :<span style="color:#f92672">=</span> <span style="color:#e6db74">&quot;value&quot;</span> <span style="color:#66d9ef">if</span> is_value_modifier <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&quot;rate&quot;</span>
    <span style="color:#66d9ef">var</span> keys: <span style="color:#a6e22e">Array</span> <span style="color:#f92672">=</span> _modifiers[stat_name][type]<span style="color:#f92672">.</span>keys()
    <span style="color:#66d9ef">if</span> keys<span style="color:#f92672">.</span>empty():
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> keys<span style="color:#f92672">.</span>back() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</pre>
<p>That’s for a solution that builds upon our code. A more object-oriented solution would be to scrap the modifiers variable and to use an array of stat modifier objects to represent modifiers, each object applying a change itself. You can do so using the command pattern we’ll see in the next lesson.</p>
<p>I prefer to avoid objects when simple functions can do the job, though, as in the above. That is, considering this is the extent of our stat upgrade system.</p>
</body>
</html>
