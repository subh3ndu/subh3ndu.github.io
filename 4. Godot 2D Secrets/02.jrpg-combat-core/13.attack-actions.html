<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>TmplTtjf3YtiX</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <style type="text/css">:root {--c-caption: grey;--c-blue: #26bfe3;--c-green: #02e180;--c-orange: #f2971a;--c-pink: #e3266f;--c-bg: #fff;--c-bg-alt: #f5f5f5;--c-text-header: #fff;--c-text-body: #95989a;--padding: 20px;--padding-inv: calc(-1 * var(--padding));--fonts: "Open Sans", -apple-system, system-ui, "Segoe UI", "Roboto","Helvetica Neue", Arial, sans-serif;--font-size: 1.1rem;}html {font-size: 100%;}body {color: #444;font-family: var(--fonts);font-size: var(--font-size);line-height: 1.7;padding: 1em;margin: auto;max-width: 800px;background: #fefefe;}a {color: #0645ad;text-decoration: none;}a:visited {color: #0b0080;}a:hover {color: #06e;}a:active {color: #faa700;}a:focus {outline: thin dotted;}a::selection {background: rgba(255, 255, 0, 0.3);color: #0645ad;}*::selection {background: rgba(255, 255, 0, 0.3);color: #000;}p {margin: 1em 0;}.caption {text-align: center;color: var(--c-caption);font-style: italic;}.note,.tips,.warning {display: block;width: calc(100% - var(--padding) * 2);padding: 0 var(--padding);padding-bottom: var(--padding);background-color: var(--c-bg-alt);}.note:before,.tips:before,.warning:before {display: block;margin: 0 var(--padding-inv) 10px var(--padding-inv);padding-left: var(--padding);font-style: bold;color: white;}.note:before {content: "Note";background-color: var(--c-blue);}.tips:before {content: "Tips";background-color: var(--c-pink);}.warning:before {content: "Warning";background-color: var(--c-orange);}img {max-width: 100%;}h1,h2,h3,h4,h5,h6 {color: #111;line-height: 125%;margin-top: 2em;font-weight: normal;}h4,h5,h6 {font-weight: bold;}h1 {font-size: 2.5em;}h2 {font-size: 2em;}h3 {font-size: 1.5em;}h4 {font-size: 1.2em;}blockquote {color: #666666;margin: 0;padding-left: 3em;border-left: 0.5em #eee solid;}hr {display: block;height: 2px;border: 0;border-top: 1px solid #aaa;border-bottom: 1px solid #eee;margin: 1em 0;padding: 0;}pre,code,kbd,samp {color: #0084b8;font-family: monospace, monospace;}pre {background-color: #f9f9f9;padding: 1em;font-size: 14px;white-space: pre-wrap;word-wrap: break-word;}code {white-space: pre-wrap;}b,strong {font-weight: bold;}dfn {font-style: italic;color: var(--c-blue);}ins {background: #ff9;color: #000;text-decoration: none;}ul,ol {margin: 1em 0;padding: 0 0 0 2em;}li p:last-child {margin-bottom: 0;}ul ul,ol ol {margin: 0.3em 0;}dl {margin-bottom: 1em;}dt {font-weight: bold;margin-bottom: 0.8em;}dd {margin: 0 0 0.8em 2em;}dd:last-child {margin-bottom: 0;}img {border: 0;-ms-interpolation-mode: bicubic;vertical-align: middle;}figure {display: block;text-align: center;margin: 1em 0;}figure img {border: none;margin: 0 auto;}figcaption {font-size: 0.8em;font-style: italic;margin: 0 0 0.8em;}.author {font-size: 1.2em;text-align: center;}tag {min-width: 3.2em;text-align: center;border-radius: 8px;padding: 0 4px;margin-bottom: 0;margin-top: 4px;margin-right: 0.2em;display: inline-block;color: white;}tag.update {background: var(--c-blue);}tag.new {background: var(--c-green);}tag.update:after {content: "update";}tag.new:after {content: "new";}button {background-color: var(--c-blue);color: white;border: none;cursor: pointer;line-height: 2rem;font-size: 1.2rem;margin: 0.75rem 0;overflow: visible;padding: 0.75rem 1.5rem;border-radius: 1rem;transition: background-color $transition-duration;white-space: nowrap;}</style>
</head>
<body>
<h1 id="creating-attack-actions">Creating attack actions</h1>
<p>With the damage formulas and <code>Action</code> abstract base class, we can now code the attacks. Here’s where we put the command pattern into practice. Our <code>AttackAction</code> objects are going to take control of the battler and targets, play animations, and more.</p>
<p>We need a new file that extends <code>Action</code> and overrides <code>Action._apply_async()</code> for attacks. An attack is going to hold one or more hits and apply them to target battlers.</p>
<p>Create a file named <code>AttackAction.gd</code> with the following code.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#75715e"># Concrete class for damaging attacks. Inflicts zero or more direct damage to </span>
<span style="color:#75715e"># one or more targets. It can also apply status effects.</span>
class_name AttackAction
<span style="color:#66d9ef">extends</span> Action

<span style="color:#75715e"># We calculate and store hits in an array to consume later, in sync with the</span>
<span style="color:#75715e"># animation.</span>
<span style="color:#66d9ef">var</span> _hits :<span style="color:#f92672">=</span> []


<span style="color:#75715e"># We must override the constructor to use it.</span>
<span style="color:#75715e"># Notice how _init() uses a unique notation to call the parent&#39;s constructor.</span>
<span style="color:#66d9ef">func</span> _init(data: AttackActionData, actor, targets: <span style="color:#a6e22e">Array</span>)<span style="color:#f92672">.</span>(data, actor, targets) <span style="color:#f92672">-&gt;</span> void:
    <span style="color:#66d9ef">pass</span>
</pre>
<p>Notice how in the constructor function above, <code>_init()</code>, we pass a <code>data</code> instance of type <code>AttackActionData</code>. That’s because we need a few more properties on the resource associated with attacks. For that, create a new file, <code>AttackActionData.gd</code> and make it extend <code>ActionData</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#75715e"># Data container used to construct [AttackAction] objects.</span>
class_name AttackActionData
<span style="color:#66d9ef">extends</span> ActionData

<span style="color:#75715e"># Multiplier applied to the calculated attack damage.</span>
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">var</span> damage_multiplier :<span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>
<span style="color:#75715e"># Hit chance rating for this attack. Works as a rate: a value of 90 means the</span>
<span style="color:#75715e"># action has a 90% chance to hit.</span>
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">var</span> hit_chance :<span style="color:#f92672">=</span> <span style="color:#ae81ff">100.0</span>
</pre>
<h2 id="implementing-the-attack-logic">Implementing the attack logic</h2>
<p>To attack a target, we’re going to use a typical object-oriented approach that consists of two steps:</p>
<ol type="1">
<li>Creating an object that represents the attack’s impact.</li>
<li>Passing it to the battler to consume.</li>
</ol>
<p>Let’s create a new <code>Hit.gd</code> script.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#75715e"># Represents a damage-dealing hit to be applied to a target Battler.</span>
<span style="color:#75715e"># Encapsulates calculations for how hits are applied based on some properties.</span>
class_name Hit
<span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Reference</span>

<span style="color:#75715e"># The damage dealt by the hit.</span>
<span style="color:#66d9ef">var</span> damage :<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#75715e"># Chance to hit in base 100.</span>
<span style="color:#66d9ef">var</span> hit_chance: <span style="color:#a6e22e">float</span>


<span style="color:#66d9ef">func</span> _init(_damage: <span style="color:#a6e22e">int</span>, _hit_chance :<span style="color:#f92672">=</span> <span style="color:#ae81ff">100.0</span>) <span style="color:#f92672">-&gt;</span> void:
    damage <span style="color:#f92672">=</span> _damage
    hit_chance <span style="color:#f92672">=</span> _hit_chance


<span style="color:#75715e"># Returns true if the hit isn&#39;t missing. To use when consuming the hit.</span>
<span style="color:#66d9ef">func</span> does_hit() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#66d9ef">return</span> randf() <span style="color:#f92672">*</span> <span style="color:#ae81ff">100.0</span> <span style="color:#f92672">&lt;</span> hit_chance
</pre>
<p>There are two main reasons to bother using a class like <code>Hit</code>:</p>
<ol type="1">
<li>It allows and forces you to pass a single value to the battler when it should take damage.</li>
<li>It encapsulates only the information the battler needs to know about the attack’s effect.</li>
</ol>
<p>In short, it can make it easier to change the code later.</p>
<p>Going back to <code>AttackAction.gd</code>, we can implement the attack logic. The code below is temporary. We’re going to lay down the foundations for now and later revisit the class to code hits that synchronize with animations.</p>
<pre style="color:#f8f8f2;background-color:#272822"><span style="color:#75715e"># Returns the damage dealt by this action. We will update this function</span>
<span style="color:#75715e"># when we implement status effects.</span>
<span style="color:#66d9ef">func</span> calculate_potential_damage_for(target) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">int</span>:
    <span style="color:#66d9ef">return</span> Formulas<span style="color:#f92672">.</span>calculate_base_damage(_data, _actor, target)


<span style="color:#66d9ef">func</span> _apply_async() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bool</span>:
    <span style="color:#75715e"># We apply the action to each target so attacks work both for single and multiple targets.</span>
    <span style="color:#66d9ef">for</span> target <span style="color:#f92672">in</span> _targets:
        <span style="color:#66d9ef">var</span> hit_chance :<span style="color:#f92672">=</span> Formulas<span style="color:#f92672">.</span>calculate_hit_chance(_data, _actor, target)
        <span style="color:#66d9ef">var</span> damage :<span style="color:#f92672">=</span> calculate_potential_damage_for(target)
        <span style="color:#66d9ef">var</span> hit :<span style="color:#f92672">=</span> Hit<span style="color:#f92672">.</span>new(damage, hit_chance)
        <span style="color:#75715e"># We&#39;re going to define a new function on the battler so it takes hits.</span>
        target<span style="color:#f92672">.</span>take_hit(hit)
    <span style="color:#75715e"># Our method is supposed to be a coroutine, that is to say, it pauses</span>
    <span style="color:#75715e"># execution and ends after some time.</span>
    <span style="color:#75715e"># in Godot 3.2, we do so using the `yield` keyword.</span>
    <span style="color:#75715e"># Here, we wait for the next frame by listening to the SceneTree&#39;s </span>
    <span style="color:#75715e"># `idle_frame` signal.</span>
    yield(Engine<span style="color:#f92672">.</span>get_main_loop(), <span style="color:#e6db74">&quot;idle_frame&quot;</span>)
    <span style="color:#66d9ef">return</span> true
</pre>
<p>And that’s a new feature in. Our battlers still can’t take hits or act, so it’s not much use, but hey, they can attack… conceptually!</p>
<p>I’d like to point out that you want to break down features and tasks like we’re doing since a few lessons when developing software. Sometimes, like with our combat system, it takes time to put all the pieces together and get a visual result. But by now, we’ve set some necessary foundations and wrote real features already.</p>
<p>Next, we’ll create stats, actions, and make battlers both take damage and act.</p>
</body>
</html>
